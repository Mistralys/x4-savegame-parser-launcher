name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  pre-build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_info.outputs.version }}
      title: ${{ steps.extract_info.outputs.title }}
      body: ${{ steps.extract_info.outputs.body }}
      prev_version: ${{ steps.extract_info.outputs.prev_version }}
      commit_sha: ${{ steps.commit.outputs.commit_hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Release Info
        id: extract_info
        run: |
          # Get latest version line (e.g., ## v1.0.0 - Initial Release)
          VERSION_LINE=$(grep -m 1 "^## v" changelog.md)
          
          # Extract version (e.g., 1.0.0)
          VERSION=$(echo "$VERSION_LINE" | sed -E 's/## v([^ ]+).*/\1/')
          
          # Extract title
          TITLE=$(echo "$VERSION_LINE" | sed -E 's/## v[^ ]+ - (.*)/\1/')
          
          # Extract changelist
          # Get the line number of the current version
          START_LINE=$(grep -n "^## v$VERSION" changelog.md | cut -d: -f1)
          # Get the body (everything after the version header until the next header or EOF)
          if [ -n "$START_LINE" ]; then
            BODY=$(tail -n +$((START_LINE + 1)) changelog.md | sed -n '/^## v/q;p')
          else
            BODY="No release notes found."
          fi
          
          # Get previous version (second version in changelog)
          PREV_VERSION=$(grep "^## v" changelog.md | sed -n '2p' | sed -E 's/## v([^ ]+).*/\1/')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "prev_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          
          # Body multiline output
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "Included in this release:"
          echo ""
          echo "$BODY"
          echo ""
          echo "----"
          if [ -n "$PREV_VERSION" ]; then
            echo "[Compare v$VERSION-v$PREV_VERSION](https://github.com/${{ github.repository }}/compare/v$PREV_VERSION...v$VERSION)"
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update versions in manifests
        run: |
          VERSION=${{ steps.extract_info.outputs.version }}
          # Update package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update tauri.conf.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

      - name: Commit version bump
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: bump version to ${{ steps.extract_info.outputs.version }} [skip ci]"
          file_pattern: "package.json src-tauri/tauri.conf.json"

  build:
    needs: pre-build
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-build.outputs.commit_sha || github.sha }}

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: install frontend dependencies
        run: npm install

      - name: run tests
        run: |
          npm test
          cd src-tauri && cargo test

      - uses: tauri-apps/tauri-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ needs.pre-build.outputs.version }}
          releaseName: "v${{ needs.pre-build.outputs.version }} - ${{ needs.pre-build.outputs.title }}"
          releaseBody: ${{ needs.pre-build.outputs.body }}
          releaseDraft: false
          prerelease: false
